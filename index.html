<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JaggerNAUT - AI Gym Trainer</title>
    <!-- 
      This application must be run from a web server (like VS Code's "Live Server" extension)
      and not by opening the HTML file directly. This is required for camera access and
      loading JavaScript modules.
    -->
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- MediaPipe JS libraries for computer vision -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <!-- All CSS styles are embedded here -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a; /* Near-black background */
            overflow: hidden; /* Prevents scrollbars during transitions */
        }
        .panel {
            background-color: #1f1f1f; /* Dark charcoal panel background */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem; /* 24px */
        }
        .accent-text {
            color: #f97316; /* Vibrant Orange */
        }
        .action-button {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-style: preserve-3d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        }
        .action-button:hover {
            transform: translateY(-6px) scale(1.05);
            filter: brightness(1.1);
        }
        .action-button:active {
            transform: translateY(-1px) scale(1);
        }
        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }
        #webcam, #output_canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Creates the mirror effect */
        }
        .feedback-box, .rep-counter-box {
            position: absolute;
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
        }
        .feedback-box { top: 1rem; left: 1rem; right: 1rem; }
        .rep-counter-box { bottom: 1rem; left: 1rem; padding: 0.5rem 1.5rem; }

        /* Page/View Transitions */
        .view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .view.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none; /* Prevents interaction with hidden views */
        }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(249, 115, 22, 0.2); }
            50% { transform: scale(1.05); box-shadow: 0 8px 30px rgba(249, 115, 22, 0.4); }
        }
        .animate-fade-in-down { animation: fadeInDown 0.8s ease-out forwards; }
        .animate-fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }
        .animate-pulse-start { animation: pulse 2s infinite ease-in-out; }
        
        /* Overlays */
        .success-overlay, .precaution-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .success-overlay { background: rgba(22, 163, 74, 0.85); }
        .precaution-overlay { background: rgba(234, 179, 8, 0.85); }
        .success-overlay.visible, .precaution-overlay.visible { opacity: 1; visibility: visible; }
        
        /* Dropdown Menu */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #1f1f1f;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dropdown-content a { color: white; padding: 12px 16px; text-decoration: none; display: block; transition: background-color 0.2s; }
        .dropdown-content a:hover { background-color: #f97316; }
        .dropdown:hover .dropdown-content { display: block; }

        /* Modal Styles */
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
    </style>
</head>
<body class="text-gray-200">

    <!-- Navigation Bar -->
    <nav class="absolute top-0 left-0 right-0 p-4 z-30 flex justify-between items-center">
        <h1 class="text-2xl font-black tracking-tighter accent-text">JaggerNAUT</h1>
        <div class="dropdown">
            <button class="font-bold py-2 px-4 rounded-lg bg-gray-800 hover:bg-gray-700 transition">Health Tools</button>
            <div class="dropdown-content">
                <a href="#" id="bmiBtn">BMI Calculator</a>
                <a href="#" id="calorieBtn">Calorie Calculator</a>
            </div>
        </div>
    </nav>

    <!-- View #1: Home Screen -->
    <div id="home-view" class="view p-4">
        <div class="text-center">
            <h1 class="text-5xl md:text-7xl font-black tracking-tighter accent-text animate-fade-in-down">JaggerNAUT</h1>
            <p class="text-2xl md:text-3xl text-gray-300 mt-4 animate-fade-in-up">Let's Get Warmed Up!</p>
            <button id="startWarmupBtn" class="action-button w-full max-w-xs mt-12 bg-orange-600 text-white font-bold py-4 px-6 rounded-xl text-xl animate-fade-in-up animate-pulse-start">
                Start Warmup
            </button>
        </div>
    </div>

    <!-- View #2: Main Exercise/Warmup Screen (Fullscreen Camera) -->
    <div id="exercise-view" class="view hidden">
        <div class="video-container">
            <video id="webcam" class="hidden" playsinline></video>
            <canvas id="output_canvas"></canvas>
            
            <!-- UI Overlays -->
            <div id="feedbackBox" class="feedback-box text-center"><p id="feedbackText" class="text-lg sm:text-xl lg:text-2xl font-bold accent-text"></p></div>
            <div id="repCounterBox" class="rep-counter-box">
                <p class="text-base sm:text-lg font-semibold text-gray-400">REPS</p>
                <p id="repCountText" class="text-4xl sm:text-5xl font-black text-white">0</p>
            </div>
            <div id="complimentBox" class="absolute top-1/4 left-1/2 -translate-x-1/2 text-2xl font-bold text-white" style="text-shadow: 0 0 8px black; opacity: 0;"></div>
            <div id="successOverlay" class="success-overlay"><h2 class="text-3xl sm:text-5xl font-black text-white tracking-wider text-center" style="text-shadow: 0 0 10px black;">LIGHT WEIGHT BABY!</h2></div>
            <div id="precautionOverlay" class="precaution-overlay"><h2 class="text-2xl sm:text-4xl font-bold text-black tracking-wider text-center">PRECAUTION:<br>Perform neck movements slowly & carefully.</h2></div>
        </div>
        
        <!-- Bottom Control Bar -->
        <div class="absolute bottom-0 left-0 right-0 z-20 p-4 flex justify-center items-center gap-4 bg-gradient-to-t from-black/50 to-transparent">
            <div id="warmup-controls" class="hidden w-full flex justify-between max-w-md">
                <button id="prevExBtn" class="action-button bg-gray-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Previous</button>
                <button id="nextExBtn" class="action-button bg-gray-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Next</button>
            </div>
            <div id="exercise-controls" class="hidden">
                <button id="finishSetBtn" class="action-button bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-8 rounded-lg text-lg">Finish Set</button>
            </div>
        </div>
    </div>
    
    <!-- View #3: Main Workout Menu -->
    <div id="menu-view" class="view hidden p-4">
        <div class="text-center w-full max-w-md">
            <button id="backToHomeBtn" class="absolute top-20 left-4 action-button bg-gray-700 text-white font-bold p-2 rounded-full text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <h1 class="text-5xl md:text-6xl font-black tracking-tight text-white animate-fade-in-down">Welcome to Heaven</h1>
            <p class="text-xl text-gray-400 mt-2 animate-fade-in-down">Choose your poison.</p>
            <div class="grid grid-cols-1 gap-4 mt-12 w-full max-w-sm mx-auto animate-fade-in-up">
                <button data-exercise="BICEP_CURLS" class="action-button w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 px-4 rounded-lg text-xl">Bicep Curls</button>
                <button data-exercise="PUSHUPS" class="action-button w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 px-4 rounded-lg text-xl">Pushups</button>
                <button data-exercise="PULLUPS" class="action-button w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 px-4 rounded-lg text-xl">Pullups</button>
            </div>
            <button id="reportBtn" class="action-button w-full max-w-sm mx-auto mt-8 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg animate-fade-in-up">View Report</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="reportModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 invisible -translate-y-4">
        <div class="panel p-6 sm:p-8 rounded-2xl w-full max-w-md">
            <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-center accent-text">Workout Summary</h2>
            <div id="reportContent" class="space-y-4 text-lg"></div>
            <div id="aiFeedbackSection" class="mt-6 hidden"><h3 class="text-xl font-bold accent-text mb-2">AI Coach Feedback</h3><div id="aiFeedbackResult" class="p-4 bg-gray-800 rounded-lg text-gray-300 text-sm whitespace-pre-wrap"></div></div>
            <div id="aiLoadingSpinner" class="hidden text-center my-4"><p class="text-gray-400 animate-pulse">✨ Your AI coach is thinking...</p></div>
            <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
                <button id="getAiFeedbackBtn" class="action-button bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 px-4 rounded-lg col-span-1 sm:col-span-3">✨ Get AI Feedback</button>
                <button id="printBtn" class="action-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">Print</button>
                <button data-modal-close="reportModal" class="action-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg col-span-1 sm:col-span-2">Close</button>
            </div>
        </div>
    </div>
    <div id="bmiModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 invisible -translate-y-4">
        <div class="panel p-6 sm:p-8 rounded-2xl w-full max-w-md">
            <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-center accent-text">BMI Calculator</h2>
            <div class="space-y-4">
                <div><label class="block mb-1 text-sm font-medium text-gray-400">Height (cm)</label><input id="bmiHeight" type="number" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white"></div>
                <div><label class="block mb-1 text-sm font-medium text-gray-400">Weight (kg)</label><input id="bmiWeight" type="number" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white"></div>
                <button id="calculateBmiBtn" class="action-button w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 px-4 rounded-lg">Calculate</button>
                <div id="bmiResult" class="text-center pt-4"></div>
            </div>
            <div class="mt-8"><button data-modal-close="bmiModal" class="action-button w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">Close</button></div>
        </div>
    </div>
    <div id="calorieModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 invisible -translate-y-4">
        <div class="panel p-6 sm:p-8 rounded-2xl w-full max-w-md">
            <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-center accent-text">Calorie Calculator</h2>
            <div class="space-y-3">
                <div><label class="block mb-1 text-sm font-medium text-gray-400">Age</label><input id="calorieAge" type="number" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white"></div>
                <div><label class="block mb-1 text-sm font-medium text-gray-400">Height (cm)</label><input id="calorieHeight" type="number" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white"></div>
                <div><label class="block mb-1 text-sm font-medium text-gray-400">Weight (kg)</label><input id="calorieWeight" type="number" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white"></div>
                <div><label class="block mb-1 text-sm font-medium text-gray-400">Gender</label><select id="calorieGender" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white"><option value="male">Male</option><option value="female">Female</option></select></div>
                <div><label class="block mb-1 text-sm font-medium text-gray-400">Activity Level</label><select id="calorieActivity" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white"><option value="1.2">Sedentary</option><option value="1.375">Lightly Active</option><option value="1.55">Moderately Active</option><option value="1.725">Very Active</option><option value="1.9">Extra Active</option></select></div>
                <button id="calculateCalorieBtn" class="action-button w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 px-4 rounded-lg !mt-6">Calculate</button>
                <div id="calorieResult" class="text-center pt-4"></div>
            </div>
            <div class="mt-8"><button data-modal-close="calorieModal" class="action-button w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">Close</button></div>
        </div>
    </div>

    <!-- All JavaScript logic is embedded here -->
    <script type="module">
        // --- DOM Elements ---
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const feedbackText = document.getElementById('feedbackText');
        const repCountText = document.getElementById('repCountText');
        const successOverlay = document.getElementById('successOverlay');
        const precautionOverlay = document.getElementById('precautionOverlay');
        const complimentBox = document.getElementById('complimentBox');
        const exerciseControls = document.getElementById('exercise-controls');
        const warmupControls = document.getElementById('warmup-controls');
        const aiFeedbackSection = document.getElementById('aiFeedbackSection');
        const aiFeedbackResult = document.getElementById('aiFeedbackResult');
        const aiLoadingSpinner = document.getElementById('aiLoadingSpinner');
        
        // --- App State Management ---
        let appState = 'IDLE'; 
        let currentView = 'home-view'; 
        let repCounter = 0;
        let stage = null; 
        let feedback = '';
        let complimentInterval;
        
        // --- Data Storage ---
        const workoutSummary = { "BICEP CURLS": 0, "PUSHUPS": 0, "PULLUPS": 0 };
        const warmupExercises = [
            { name: "FINGER SPREADS", reps_required: 5, precaution: false },
            { name: "NECK TURNS (L/R)", reps_required: 4, precaution: true },
            { name: "NECK NODS (U/D)", reps_required: 4, precaution: true },
            { name: "SMILE", reps_required: 1, precaution: false }
        ];
        let currentExerciseIndex = 0;
        const compliments = ['Great Form!', 'Keep Pushing!', 'You Got This!', 'Awesome Work!', 'Feel the Burn!'];

        // --- Core Functions ---
        function switchView(viewId) {
            document.getElementById(currentView).classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
            currentView = viewId;
        }

        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            return angle > 180.0 ? 360 - angle : angle;
        }

        function updateUI() {
            feedbackText.textContent = feedback;
            repCountText.textContent = repCounter;
        }

        function showWarmupSuccess() {
            appState = 'SUCCESS';
            successOverlay.classList.add('visible');
            setTimeout(() => {
                successOverlay.classList.remove('visible');
                switchView('menu-view');
                appState = 'IDLE';
                warmupControls.classList.add('hidden');
            }, 3000);
        }

        function showCompliment() {
            const compliment = compliments[Math.floor(Math.random() * compliments.length)];
            complimentBox.textContent = compliment;
            complimentBox.style.animation = 'fadeIn 0.5s ease-out forwards';
            setTimeout(() => {
                complimentBox.style.animation = 'fadeOut 0.5s ease-in forwards';
            }, 2000);
        }

        function startCompliments() {
            if (complimentInterval) clearInterval(complimentInterval);
            complimentInterval = setInterval(showCompliment, 7000);
        }

        function stopCompliments() {
            clearInterval(complimentInterval);
        }

        // --- MediaPipe Initialization ---
        const pose = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.5 });
        
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            const poseLandmarks = results.poseLandmarks;
            const handLandmarks = results.multiHandLandmarks;

            if (poseLandmarks) {
                drawConnectors(canvasCtx, poseLandmarks, POSE_CONNECTIONS, { color: '#f97316', lineWidth: 4 });
                drawLandmarks(canvasCtx, poseLandmarks, { color: '#ffffff', lineWidth: 2 });
            }
            if (handLandmarks) {
                for (const landmarks of handLandmarks) {
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: '#fb923c', lineWidth: 2 });
                    drawLandmarks(canvasCtx, landmarks, { color: '#fed7aa', lineWidth: 2 });
                }
            }

            try {
                if (appState === 'WARMUP') handleWarmup(poseLandmarks, handLandmarks);
                else if (appState !== 'IDLE' && appState !== 'SUCCESS') handleExercise(poseLandmarks);
            } catch (error) { /* Silently ignore errors */ }
            
            updateUI();
            canvasCtx.restore();
        }
        
        pose.onResults(onResults);
        hands.onResults(onResults);

        // --- Camera Setup ---
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                if (!videoElement.videoWidth) return;
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                await pose.send({ image: videoElement });
                if (appState === 'WARMUP' && currentExerciseIndex === 0) {
                    await hands.send({image: videoElement});
                }
            },
            width: 1280,
            height: 720
        });

        // --- Event Listeners ---
        document.getElementById('startWarmupBtn').addEventListener('click', () => {
            switchView('exercise-view');
            appState = 'WARMUP';
            updateWarmupExercise();
            camera.start();
            warmupControls.classList.remove('hidden');
            startCompliments();
        });

        document.querySelectorAll('#menu-view button[data-exercise]').forEach(button => {
            button.addEventListener('click', () => {
                const exercise = button.dataset.exercise;
                const exerciseNameMap = { "BICEP_CURLS": "BICEP CURLS", "PUSHUPS": "PUSHUPS", "PULLUPS": "PULLUPS" };
                appState = exercise;
                feedback = `STARTING ${exerciseNameMap[exercise]}`;
                repCounter = 0;
                stage = null;
                exerciseControls.classList.remove('hidden');
                warmupControls.classList.add('hidden');
                switchView('exercise-view');
                startCompliments();
            });
        });
        
        document.getElementById('finishSetBtn').addEventListener('click', () => {
            appState = 'IDLE';
            exerciseControls.classList.add('hidden');
            switchView('menu-view');
            stopCompliments();
        });
        
        document.getElementById('backToHomeBtn').addEventListener('click', () => switchView('home-view'));

        // Warmup Navigation
        function updateWarmupExercise() {
            repCounter = 0;
            stage = null;
            const exercise = warmupExercises[currentExerciseIndex];
            feedback = `DO: ${exercise.name}`;
            if (exercise.precaution) {
                precautionOverlay.classList.add('visible');
                setTimeout(() => precautionOverlay.classList.remove('visible'), 3000);
            }
        }
        document.getElementById('nextExBtn').addEventListener('click', () => {
            if (currentExerciseIndex < warmupExercises.length - 1) {
                currentExerciseIndex++;
                updateWarmupExercise();
            }
        });
        document.getElementById('prevExBtn').addEventListener('click', () => {
            if (currentExerciseIndex > 0) {
                currentExerciseIndex--;
                updateWarmupExercise();
            }
        });

        // Modal Logic
        function openModal(modalId) { document.getElementById(modalId).classList.remove('invisible', 'opacity-0', '-translate-y-4'); }
        function closeModal(modalId) { 
            const modal = document.getElementById(modalId);
            modal.classList.add('invisible', 'opacity-0', '-translate-y-4');
            if (modalId === 'reportModal') {
                aiFeedbackSection.classList.add('hidden');
                aiFeedbackResult.textContent = '';
            }
        }
        document.getElementById('reportBtn').addEventListener('click', () => {
            document.getElementById('reportContent').innerHTML = Object.entries(workoutSummary)
                .map(([exercise, count]) => `<div class="flex justify-between items-center bg-gray-800 p-3 rounded-lg"><span class="font-semibold text-gray-300">${exercise}</span><span class="font-black text-2xl text-white">${count}</span></div>`)
                .join('') || '<p class="text-center text-gray-400">No workout data yet. Go crush a set!</p>';
            openModal('reportModal');
        });
        document.getElementById('bmiBtn').addEventListener('click', () => openModal('bmiModal'));
        document.getElementById('calorieBtn').addEventListener('click', () => openModal('calorieModal'));
        document.querySelectorAll('[data-modal-close]').forEach(button => {
            button.addEventListener('click', () => closeModal(button.dataset.modalClose));
        });
        document.getElementById('printBtn').addEventListener('click', () => {
            const reportHTML = `<html><head><title>JaggerNAUT Workout Report</title><style>body{font-family:sans-serif;margin:40px}h1{text-align:center}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #ddd;padding:12px;text-align:left}th{background-color:#f2f2f2}</style></head><body><h1>JaggerNAUT Workout Report</h1><table><thead><tr><th>Exercise</th><th>Repetitions</th></tr></thead><tbody>${Object.entries(workoutSummary).map(([ex, count]) => `<tr><td>${ex}</td><td>${count}</td></tr>`).join('')}</tbody></table></body></html>`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            printWindow.print();
        });

        // --- Gemini API Integration ---
        document.getElementById('getAiFeedbackBtn').addEventListener('click', async () => {
            const workoutString = Object.entries(workoutSummary).filter(([, reps]) => reps > 0).map(([exercise, reps]) => `${exercise}: ${reps} reps`).join(', ');
            if (!workoutString) {
                aiFeedbackResult.textContent = "You haven't completed any exercises yet. Do a set and come back for feedback!";
                aiFeedbackSection.classList.remove('hidden');
                return;
            }
            const prompt = `You are JaggerNAUT, a hyper-motivational and knowledgeable AI fitness coach. Your tone is energetic and encouraging, but also smart. Based on the following workout summary, provide feedback in three short sections using markdown for formatting: 1. **THE PUMP:** Give some positive reinforcement about the work done. 2. **NEXT LEVEL:** Suggest one specific thing to focus on next time (like a new exercise, more reps, or better form). 3. **FUEL UP:** Recommend a simple, healthy post-workout meal idea. Keep the entire response concise and easy to read. Here's the workout: ${workoutString}`;
            aiLoadingSpinner.classList.remove('hidden');
            aiFeedbackSection.classList.add('hidden');
            try {
                const apiKey = "AIzaSyDQ3ZLOpe2vBRiaPEd5jBZF-6oTm_fg-vc";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                const feedbackText = result.candidates[0].content.parts[0].text;
                aiFeedbackResult.innerHTML = feedbackText.replace(/\*\*(.*?)\*\*/g, '<strong class="accent-text">$1</strong>');
            } catch (error) {
                console.error("Gemini API Error:", error);
                aiFeedbackResult.textContent = "Sorry, the AI coach is currently unavailable. Please try again later.";
            } finally {
                aiLoadingSpinner.classList.add('hidden');
                aiFeedbackSection.classList.remove('hidden');
            }
        });

        // Health Tool Logic
        document.getElementById('calculateBmiBtn').addEventListener('click', () => {
            const height = parseFloat(document.getElementById('bmiHeight').value), weight = parseFloat(document.getElementById('bmiWeight').value), resultEl = document.getElementById('bmiResult');
            if (height > 0 && weight > 0) {
                const bmi = (weight / ((height / 100) ** 2)).toFixed(1);
                let category = (bmi < 18.5) ? 'Underweight' : (bmi < 24.9) ? 'Normal weight' : (bmi < 29.9) ? 'Overweight' : 'Obesity';
                resultEl.innerHTML = `<p class="text-xl">Your BMI: <span class="font-bold text-2xl accent-text">${bmi}</span></p><p class="text-gray-400">Category: ${category}</p>`;
            } else { resultEl.innerHTML = `<p class="text-red-500">Please enter valid height and weight.</p>`; }
        });
        document.getElementById('calculateCalorieBtn').addEventListener('click', () => {
            const age = parseInt(document.getElementById('calorieAge').value), height = parseFloat(document.getElementById('calorieHeight').value), weight = parseFloat(document.getElementById('calorieWeight').value), gender = document.getElementById('calorieGender').value, activity = parseFloat(document.getElementById('calorieActivity').value), resultEl = document.getElementById('calorieResult');
            if (age > 0 && height > 0 && weight > 0) {
                let bmr = (10 * weight) + (6.25 * height) - (5 * age) + (gender === 'male' ? 5 : -161);
                const maintenance = Math.round(bmr * activity);
                resultEl.innerHTML = `<p class="text-lg">Maintenance: <span class="font-bold text-xl accent-text">${maintenance}</span> kcal/day</p><p class="text-gray-400 text-sm">Weight Loss: ~${maintenance - 500} kcal | Weight Gain: ~${maintenance + 500} kcal</p>`;
            } else { resultEl.innerHTML = `<p class="text-red-500">Please fill in all fields correctly.</p>`; }
        });

        // --- Exercise Logic Handlers ---
        function handleWarmup(poseLandmarks, handLandmarks) {
            if (currentExerciseIndex >= warmupExercises.length) { showWarmupSuccess(); return; }
            const currentExercise = warmupExercises[currentExerciseIndex];
            if (currentExercise.name === "FINGER SPREADS") {
                if (handLandmarks && handLandmarks.length > 0) {
                    const lm = handLandmarks[0];
                    if (lm[8].y < lm[6].y) stage = "open";
                    if (lm[8].y > lm[6].y && stage === 'open') { stage = "closed"; repCounter++; }
                } else { feedback = "SHOW YOUR HAND"; }
            } else if (poseLandmarks) {
                 const lm = poseLandmarks;
                 if (currentExercise.name === "NECK TURNS (L/R)") {
                    if (lm[0].x > lm[11].x) stage = "left";
                    if (lm[0].x < lm[12].x && stage === 'left') { stage = "right"; repCounter++; }
                } else if (currentExercise.name === "NECK NODS (U/D)") {
                    const shoulderMidY = (lm[11].y + lm[12].y) / 2;
                    if (lm[0].y > shoulderMidY) stage = "down";
                    if (lm[0].y < shoulderMidY && stage === 'down') { stage = "up"; repCounter++; }
                } else if (currentExercise.name === "SMILE") {
                    feedback = "NOW SMILE!";
                    const mouthWidth = Math.hypot(lm[9].x - lm[10].x, lm[9].y - lm[10].y);
                    const eyeWidth = Math.hypot(lm[2].x - lm[5].x, lm[2].y - lm[5].y);
                    if ((mouthWidth / eyeWidth) > 0.7) repCounter++;
                }
            }
            if (repCounter >= currentExercise.reps_required) {
                if (currentExerciseIndex < warmupExercises.length - 1) {
                    currentExerciseIndex++;
                    updateWarmupExercise();
                } else {
                    showWarmupSuccess();
                }
            }
        }

        function handleExercise(landmarks) {
            if (!landmarks) return;
            const leftAngle = calculateAngle(landmarks[11], landmarks[13], landmarks[15]);
            const rightAngle = calculateAngle(landmarks[12], landmarks[14], landmarks[16]);
            let up_angle, down_angle, up_stage, down_stage, exName;
            switch(appState) {
                case "BICEP_CURLS": [up_angle, down_angle, up_stage, down_stage, exName] = [40, 160, "up", "down", "BICEP CURLS"]; break;
                case "PUSHUPS": [up_angle, down_angle, up_stage, down_stage, exName] = [90, 160, "down", "up", "PUSHUPS"]; break;
                case "PULLUPS": [up_angle, down_angle, up_stage, down_stage, exName] = [70, 150, "up", "down", "PULLUPS"]; break;
            }
            feedback = exName;
            if (leftAngle > down_angle && rightAngle > down_angle) stage = down_stage;
            if (leftAngle < up_angle && rightAngle < up_angle && stage === down_stage) {
                stage = up_stage;
                repCounter++;
                workoutSummary[exName]++;
            }
        }
    </script>
</body>
</ht>
